
 RUN  v3.2.4 /Users/qrq/Documents/code/05-web-projects/ agent-flow-lite/frontend

stderr | src/__tests__/auth/login.spec.ts > Refresh-Logout Bug (RED PHASE) > network failure during /me should gracefully handle without breaking
Failed to fetch user profile: Error: Network Error
    at [90m/Users/qrq/Documents/code/05-web-projects/ agent-flow-lite/frontend/[39msrc/__tests__/auth/login.spec.ts:206:48
    at [90mfile:///Users/qrq/Documents/code/05-web-projects/%20agent-flow-lite/frontend/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///Users/qrq/Documents/code/05-web-projects/%20agent-flow-lite/frontend/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///Users/qrq/Documents/code/05-web-projects/%20agent-flow-lite/frontend/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/qrq/Documents/code/05-web-projects/%20agent-flow-lite/frontend/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m
    at runTest [90m(file:///Users/qrq/Documents/code/05-web-projects/%20agent-flow-lite/frontend/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1574:12[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at runSuite [90m(file:///Users/qrq/Documents/code/05-web-projects/%20agent-flow-lite/frontend/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m
    at runSuite [90m(file:///Users/qrq/Documents/code/05-web-projects/%20agent-flow-lite/frontend/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1729:8[90m)[39m

 â¯ src/__tests__/auth/login.spec.ts (28 tests | 7 failed) 49ms
   âœ“ Auth Store > should initialize with null token and user 1ms
   âœ“ Auth Store > should set isAuthenticated to true when both token and user exist 0ms
   âœ“ Auth Store > should login successfully and store token 1ms
   âœ“ Auth Store > should logout successfully and clear state 0ms
   Ã— Auth Store > should init from localStorage 2ms
     â†’ expected Promise{â€¦} to be true // Object.is equality
   Ã— Auth Store > should return false from init when no token in localStorage 0ms
     â†’ expected Promise{â€¦} to be false // Object.is equality
   âœ“ Auth Store > should clear auth state 0ms
   Ã— Refresh-Logout Bug (RED PHASE) > init with cached token should restore both token and user for isAuthenticated=true 0ms
     â†’ expected null not to be null
   Ã— Refresh-Logout Bug (RED PHASE) > refresh with valid token but missing user should trigger revalidation via /api/v1/auth/me 0ms
     â†’ expected Promise{â€¦} to be true // Object.is equality
   âœ“ Refresh-Logout Bug (RED PHASE) > 401 from /me should clear auth state and redirect to /login 0ms
   âœ“ Refresh-Logout Bug (RED PHASE) > network failure during /me should gracefully handle without breaking 1ms
   âœ“ Refresh-Logout Bug (RED PHASE) > isAuthenticated should be false when token exists but user is null 0ms
   Ã— Refresh-Logout Bug (RED PHASE) > should restore user from localStorage if cached during init 1ms
     â†’ expected "spy" to not be called at all, but actually been called 1 times[90m

Received: 

[1m  1st spy call:

[22m    Array [
      "/api/v1/auth/me",
    ]
[39m[90m

Number of calls: [1m1[22m
[39m
   âœ“ LoginView > should mount component successfully 12ms
   âœ“ LoginView > should display login title 2ms
   âœ“ LoginView > should display email input 2ms
   âœ“ LoginView > should display login button 1ms
   âœ“ LoginView > should show error for empty email 3ms
   âœ“ LoginView > should show error for invalid email format 2ms
   âœ“ LoginView > should call login API with valid email 2ms
   âœ“ LoginView > should redirect to home after successful login 2ms
   âœ“ LoginView > should show error message on login failure 4ms
   âœ“ LoginView > should display register CTA button 1ms
   âœ“ LoginView > should call login API when register CTA is clicked with valid email 1ms
   âœ“ App Chrome Hiding on Login > should hide header on /login route 2ms
   âœ“ App Chrome Hiding on Login > should hide sidebar on /login route 1ms
   Ã— App Chrome Hiding on Login > should show header on non-login routes 3ms
     â†’ expected false to be true // Object.is equality
   Ã— App Chrome Hiding on Login > should show sidebar on non-login routes 1ms
     â†’ expected false to be true // Object.is equality

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 7 â¯â¯â¯â¯â¯â¯â¯

 FAIL  src/__tests__/auth/login.spec.ts > Auth Store > should init from localStorage
AssertionError: expected Promise{â€¦} to be true // Object.is equality

[32m- Expected:[39m 
true

[31m+ Received:[39m 
Promise {}

 â¯ src/__tests__/auth/login.spec.ts:95:20
     93|     const result = authStore.init()
     94| 
     95|     expect(result).toBe(true)
       |                    ^
     96|     expect(authStore.token).toBe('stored-token')
     97|   })

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/7]â¯

 FAIL  src/__tests__/auth/login.spec.ts > Auth Store > should return false from init when no token in localStorage
AssertionError: expected Promise{â€¦} to be false // Object.is equality

[32m- Expected:[39m 
false

[31m+ Received:[39m 
Promise {}

 â¯ src/__tests__/auth/login.spec.ts:103:20
    101|     const result = authStore.init()
    102| 
    103|     expect(result).toBe(false)
       |                    ^
    104|     expect(authStore.token).toBeNull()
    105|   })

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/7]â¯

 FAIL  src/__tests__/auth/login.spec.ts > Refresh-Logout Bug (RED PHASE) > init with cached token should restore both token and user for isAuthenticated=true
AssertionError: expected null not to be null
 â¯ src/__tests__/auth/login.spec.ts:143:32
    141|     // because init() doesn't restore user from anywhere
    142|     expect(authStore.token).toBe('cached-token')
    143|     expect(authStore.user).not.toBeNull()
       |                                ^
    144|     expect(authStore.isAuthenticated).toBe(true)
    145|   })

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/7]â¯

 FAIL  src/__tests__/auth/login.spec.ts > Refresh-Logout Bug (RED PHASE) > refresh with valid token but missing user should trigger revalidation via /api/v1/auth/me
AssertionError: expected Promise{â€¦} to be true // Object.is equality

[32m- Expected:[39m 
true

[31m+ Received:[39m 
Promise {}

 â¯ src/__tests__/auth/login.spec.ts:162:20
    160|     const result = authStore.init()
    161| 
    162|     expect(result).toBe(true)
       |                    ^
    163|     expect(authStore.token).toBe('valid-token')
    164| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/7]â¯

 FAIL  src/__tests__/auth/login.spec.ts > Refresh-Logout Bug (RED PHASE) > should restore user from localStorage if cached during init
AssertionError: expected "spy" to not be called at all, but actually been called 1 times[90m

Received: 

[1m  1st spy call:

[22m    Array [
      "/api/v1/auth/me",
    ]
[39m[90m

Number of calls: [1m1[22m
[39m
 â¯ src/__tests__/auth/login.spec.ts:252:27
    250|     // Even if we cache user in localStorage, init() doesn't read it
    251|     // Current implementation only reads auth_token
    252|     expect(axios.get).not.toHaveBeenCalled() // Currently no /me call
       |                           ^
    253|   })
    254| })

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/7]â¯

 FAIL  src/__tests__/auth/login.spec.ts > App Chrome Hiding on Login > should show header on non-login routes
AssertionError: expected false to be true // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

 â¯ src/__tests__/auth/login.spec.ts:503:29
    501| 
    502|     const header = wrapper.find('.app-header')
    503|     expect(header.exists()).toBe(true)
       |                             ^
    504|   })
    505| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/7]â¯

 FAIL  src/__tests__/auth/login.spec.ts > App Chrome Hiding on Login > should show sidebar on non-login routes
AssertionError: expected false to be true // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

 â¯ src/__tests__/auth/login.spec.ts:517:30
    515| 
    516|     const sidebar = wrapper.find('.app-sidebar')
    517|     expect(sidebar.exists()).toBe(true)
       |                              ^
    518|   })
    519| })

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/7]â¯


 Test Files  1 failed (1)
      Tests  7 failed | 21 passed (28)
   Start at  20:27:26
   Duration  685ms (transform 92ms, setup 0ms, collect 141ms, tests 49ms, environment 252ms, prepare 59ms)

